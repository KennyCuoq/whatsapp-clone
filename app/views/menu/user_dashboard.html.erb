<div class="container" id="container-dashboard">
  <div class="navbar">
    <%= link_to destroy_user_session_path, method: :delete do %>
      <i class="fas fa-cog icon"></i>
    <% end %>
    <h4>Chats</h4>
    <i class="far fa-edit icon new-chat"></i>
  </div>
  <div class="chat-list">
    <div id="add-contact">
      <%= simple_form_for(Message.new) do |f| %>
        <%= f.input :recipient, placeholder: "Type contact's username eg: 'Kenny'",  label: false %>
        <%= f.button :button, class: 'add-icon' do %>
          <i class="fas fa-user-plus blue"></i>
        <% end %>
      <% end %>
    </div>
    <% @chats.each do |chat| %>
      <%= link_to chat_path(chat) do  %>
        <%= render 'chat_card', chat: chat, user: @user %>
      <% end %>
    <% end %>
  </div>
</div>


<% content_for :after_js do %>
  <%= javascript_pack_tag 'contact-form' %>
  <script>
    function updateChatCard(data) {
      const chatCard = document.getElementById(`chat-card-${data.chat_id}`);
      const contactForm = document.getElementById('add-contact');
      if (chatCard) {
        chatCard.remove();
      }
      contactForm.insertAdjacentHTML('afterend', `${data.chat_partial}`);
    }

    App['user_<%= @user.id %>'] = App.cable.subscriptions.create({ channel: 'UsersChannel', user_id: <%= @user.id %> }, {
      received: (data) => {
        updateChatCard(data);
      }
    })

  </script>

<% end %>
