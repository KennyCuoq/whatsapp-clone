<%= render 'chats/navbar_send' %>
<div class="container container-messages">
  <% @chat.sort_chronologically.each do |message| %>
    <% was_sent_by_user = (message.sender == @user)%>
    <%= render 'messages/message', message: message, was_sent_by_user: was_sent_by_user %>
  <% end %>
</div>
  <%= render 'chats/footer_send' %>

<% content_for :after_js do %>
  <script>
    function removePreviousBubbleArrow() {
      const allMessages = document.querySelectorAll('.bubble')
      const lastMessage = allMessages[allMessages.length-1]
      if (!lastMessage.classList.contains('sent')) {
        const bubbleArrow = lastMessage.lastElementChild;
        bubbleArrow.remove();
      }
    }
    scrollLastMessageIntoView();
    App['chat_<%= @chat.id %>'] = App.cable.subscriptions.create({ channel: 'ChatsChannel', chat_id: <%= @chat.id %> }, {
      received: (data) => {
        if (data.current_user_id !== <%= @user.id %>) {
          const messagesContainer = document.querySelector('.container-messages');
          removePreviousBubbleArrow();
          messagesContainer.insertAdjacentHTML('beforeend', data.message_partial);
          scrollLastMessageIntoView();
        }
      }
    })
  </script>
<% end %>













